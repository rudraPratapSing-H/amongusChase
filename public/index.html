<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>Vent Chase - The Story</title>
    <!-- Link to your external stylesheet -->
    <link rel="stylesheet" href="story_style.css" />
    <!-- Linking the required fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600&family=Roboto:wght@400&display=swap"
      rel="stylesheet"
    />
    <!-- Tone.js for sound effects -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
      body,
      .story-container,
      .dialogue-box,
      #story-text-element,
      #nav-button,
      #skip-story {
        user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
      }
    </style>
  </head>
  <body>
    <!-- This overlay ensures audio can start on the first user interaction -->
    <div id="start-story-overlay">
      <p>Click to Begin Transmission</p>
    </div>

    <!-- FIX: Re-added the main story container div that the CSS relies on -->
    <div class="story-container">
      <div class="image-container" id="image-container">
        <!-- Images will be dynamically added here by JavaScript -->
      </div>
              <p
      style="
        text-align: center;
        font-size: 0.95em;
        color: #00ffff;
        margin-top: 24px;
        user-select: none;
      "
    > Story by Uthkarsh Mandloi
    </p>
     

      <button
        id="skip-story"
        style="position: absolute; top: 16px; right: 16px; z-index: 1001"
      >
        Skip
      </button>

      <div class="dialogue-box" id="dialogue-box">
        <p class="story-text" id="story-text-element"></p>
        <button id="nav-button">Next</button>
      </div>

    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- Story Content (Updated with corrected image paths) ---
        const scenes = [
          {
            image: "Images/Scen_1.jpg", // FIX: Reverted to 'Images'
            text: "In the cold silence of space, a shadow hides among the stars.\nAn alien impostor boards the vessel, disguised as one of the crew.",
          },
          {
            image: "Images/Scen_2.jpg", // FIX: Reverted to 'Images'
            text: "At first, no one suspects.\nBut soon—\nsystems fail, engines sputter, and trust fractures.\nThe impostor strikes without mercy… one by one, the crew falls.",
          },
          {
            image: "Images/Scen_3.jpg", // FIX: Reverted to 'Images'
            text: "When the last breath fades, the impostor claims the ship’s heart—\nthe reactor core.\nWith alarms wailing across empty halls, the predator prepares its escape.",
          },
          {
            image: "Images/Scen_4.jpg", // FIX: Reverted to 'Images'
            text: "Yet… all is not lost.\nDeep within the ship, a stasis pod hisses open.\nA lone crewmate awakens, ready to fight back against the impostor.",
          },
          {
            image: "Images/Scen_5.jpg", // FIX: Reverted to 'Images'
            text: "They find the silence of death…\nthe journal of a fallen friend…\nand the truth of betrayal.",
          },
          {
            image: "Images/Scen_6.jpg", // FIX: Reverted to 'Images'
            text: "Now armed and resolute,\nthe survivor rises with a single mission:",
          },
          {
            image: "Images/Scen_7.jpg", // FIX: Reverted to 'Images'
            text: "Hunt the impostor. Stop its escape.\nAvenge the crew…\nor die as the last casualty.",
          },
        ];

        // --- DOM Elements ---
        const startOverlay = document.getElementById("start-story-overlay");
        const imageContainer = document.getElementById("image-container");
        const dialogueBox = document.getElementById("dialogue-box"); // Added dialogue box
        const storyTextElement = document.getElementById("story-text-element");
        const navButton = document.getElementById("nav-button");

        // --- State ---
        let currentSceneIndex = 0;
        let isTyping = false;
        let audioStarted = false;
        let typingTimeout = null; // Use a timeout for recursive typing

        // --- Sound Synthesis (Updated for a softer sound) ---
        const typewriterSound = new Tone.Synth({
          oscillator: { type: "triangle" }, // Softer sound wave
          envelope: { attack: 0.005, decay: 0.05, sustain: 0, release: 0.1 },
          volume: -25, // Quieter volume
        }).toDestination();

        /**
         * Types out text, handling line breaks and pauses.
         */
        function typeText(element, text, onComplete) {
          if (typingTimeout) clearTimeout(typingTimeout);

          isTyping = true;
          navButton.style.visibility = "hidden"; // Hide button during typing
          element.innerHTML = ""; // Use innerHTML to render <br> tags
          element.classList.remove("typing-done");
          let i = 0;

          const type = () => {
            if (i < text.length) {
              const char = text.charAt(i);
              if (char === "\n") {
                element.innerHTML += "<br>";
                // Pause for a moment after a line break
                typingTimeout = setTimeout(type, 400);
              } else {
                element.innerHTML += char;
                if (audioStarted) {
                  // Lower, randomized pitch for a more pleasant effect
                  typewriterSound.triggerAttackRelease(
                    400 + Math.random() * 100,
                    "32n"
                  );
                }
                // Continue typing normally
                typingTimeout = setTimeout(type, 40);
              }
              i++;
            } else {
              isTyping = false;
              navButton.style.visibility = "visible"; // Show button when done
              element.classList.add("typing-done");
              if (onComplete) onComplete();
            }
          };
          type(); // Start the recursive typing function
        }
        document.getElementById("skip-story").onclick = function () {
          window.location.href = "main_game.html";
        };

        /**
         * Pre-loads all scene images into the DOM.
         */
        function initializeImages() {
          scenes.forEach((scene, index) => {
            const img = document.createElement("img");
            img.src = scene.image;
            img.alt = `Scene ${index + 1}`;
            img.classList.add("scene-image");
            img.onerror = () => {
              img.src = `https://placehold.co/1920x1080/0d0d1a/00ffff?text=Scene+${
                index + 1
              }+Not+Found`;
            };
            imageContainer.appendChild(img);
          });
        }

        /**
         * Displays a specific scene by its index.
         */
        function showScene(index) {
          const allImages = document.querySelectorAll(".scene-image");
          allImages.forEach((img, imgIndex) => {
            img.classList.toggle("active", imgIndex === index);
          });

          typeText(storyTextElement, scenes[index].text);

          if (index === scenes.length - 1) {
            navButton.textContent = "Begin Mission";
          } else {
            navButton.textContent = "Next";
          }
        }

        // --- Event Listeners ---
        startOverlay.addEventListener(
          "click",
          async () => {
            // This is the crucial first interaction to enable audio
            if (!audioStarted) {
              await Tone.start();
              audioStarted = true;
              console.log("Audio context started");
            }
            startOverlay.style.display = "none"; // Hide overlay
            showScene(0); // Show the first scene, now with sound ready
          },
          { once: true }
        );

        navButton.addEventListener("click", async () => {
          if (isTyping) return;

          if (!audioStarted) {
            await Tone.start();
            audioStarted = true;
            console.log("Audio context started");
          }

          if (currentSceneIndex < scenes.length - 1) {
            currentSceneIndex++;
            showScene(currentSceneIndex);
          } else {
            window.location.href = "main_game.html";
          }
        });

        // --- Event listener to skip typing animation ---
        dialogueBox.addEventListener("click", (event) => {
          // If the click was on the button itself, do nothing.
          // This allows the button's own click listener to handle the event.
          if (event.target === navButton) {
            return;
          }

          if (isTyping) {
            // Stop the current animation timer
            clearTimeout(typingTimeout);

            // Get the full text for the current scene
            const fullText = scenes[currentSceneIndex].text;

            // Instantly display the full text, converting newlines to <br>
            storyTextElement.innerHTML = fullText.replace(/\n/g, "<br>");

            // Update all state flags to reflect that typing is done
            isTyping = false;
            navButton.style.visibility = "visible";
            storyTextElement.classList.add("typing-done");
          }
        });

        // --- Initial Setup ---
        initializeImages();
        // The story now waits for the user to click the overlay before starting.
      });
    </script>
   
     
  </body>
</html>
